-- services
local players = game:GetService("Players")
local uis = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local starterGui = game:GetService("StarterGui")
local workspace = game:GetService("Workspace")

local plr = players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")

-- flight settings
local FlyingSpeed = {
	flags = {
		FlyUpSpeed = 150,
		FallSpeed = 80,
		FlySpeed = 150,
	}
}

local flying = false
local velocity = Vector3.new(0, 0, 0)
local currentMode = 1
local modes = {"FlyUpSpeed", "FallSpeed", "FlySpeed"}

local function notify(title, text)
	starterGui:SetCore("SendNotification", {
		Title = title,
		Text = text,
		Duration = 2
	})
end

local function updateFlying()
	if flying then
		if uis:IsKeyDown(Enum.KeyCode.Space) and not uis:GetFocusedTextBox() then
			velocity = Vector3.new(0, FlyingSpeed.flags.FlyUpSpeed, 0)
		else
			velocity = Vector3.new(0, -FlyingSpeed.flags.FallSpeed, 0)
		end

		if hum.MoveDirection.Magnitude > 0 then
			velocity += hum.MoveDirection.Unit * FlyingSpeed.flags.FlySpeed
		end

		hrp.Velocity = velocity
	end
end

local function toggleFly(input)
	if input.KeyCode == Enum.KeyCode.Z then
		flying = not flying
		hrp.Velocity = Vector3.new(0, 0, 0)
		local status = flying and "enabled" or "disabled"
		notify("flight", "flight has been " .. status .. ".")
	end
end

local function resetFlightOnRespawn()
	plr.CharacterAdded:Connect(function(character)
		hrp = character:WaitForChild("HumanoidRootPart")
		hum = character:WaitForChild("Humanoid")
		flying = false
		velocity = Vector3.new(0, 0, 0)
		hrp.Velocity = Vector3.new(0, 0, 0)
		notify("flight", "flight has been reset.")
	end)
end

local function toggleFallDamage(input)
	if input.KeyCode == Enum.KeyCode.N and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		local remotes = workspace.Live[plr.Name].CharacterHandler.Remotes
		local fall1 = remotes:FindFirstChild("ApplyFallDamage")
		local fall2 = remotes:FindFirstChild("ApplyFallDamag")

		if fall1 then
			fall1.Name = "ApplyFallDamag"
			notify("fall damage", "fall damage disabled.")
		elseif fall2 then
			fall2.Name = "ApplyFallDamage"
			notify("fall damage", "fall damage enabled.")
		else
			notify("error", "couldn't find fall damage remote.")
		end
	end
end

local function handleKeyPress(input)
	if input.KeyCode == Enum.KeyCode.P and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		currentMode = currentMode % #modes + 1
		local mode = modes[currentMode]
		notify("editing " .. mode, "current value: " .. FlyingSpeed.flags[mode])
	end

	if input.KeyCode == Enum.KeyCode.Equals and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		local mode = modes[currentMode]
		FlyingSpeed.flags[mode] += 25
		notify(mode .. " increased", "new value: " .. FlyingSpeed.flags[mode])
	end

	if input.KeyCode == Enum.KeyCode.Minus and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		local mode = modes[currentMode]
		FlyingSpeed.flags[mode] -= 25
		notify(mode .. " decreased", "new value: " .. FlyingSpeed.flags[mode])
	end
end




runService.Heartbeat:Connect(updateFlying)
resetFlightOnRespawn()

-- spectate
local isSpectating = false
local function spectatePlayer(player)
	if isSpectating then
		if plr.Character then
			isSpectating = false
			workspace.CurrentCamera.CameraSubject = plr.Character
		end
		return
	end

	isSpectating = true
	if player.Character then
		workspace.CurrentCamera.CameraSubject = player.Character
	end
end

local function blackballs(label)
	local player
	for _, v in pairs(players:GetPlayers()) do
		if v.Character and string.lower(v.Character.Name) == string.lower((tostring(label.Text):gsub("[^%w%s_]+", ""))) then
			player = v
			break
		end
	end

	if player then
		task.spawn(spectatePlayer, player)
		if isSpectating then
			label.TextColor3 = Color3.new(1, 0, 0)
			for _, v in pairs(label.Parent:GetChildren()) do
				if v ~= label then v.TextColor3 = Color3.new(1, 1, 1) end
			end
		else
			for _, v in pairs(label.Parent:GetChildren()) do
				v.TextColor3 = Color3.new(1, 1, 1)
			end
		end
	end
end

pcall(function()
	uis.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.MouseButton2 then
			local objs = plr.PlayerGui:GetGuiObjectsAtPosition(input.Position.X, input.Position.Y)
			local label = objs[1]
			if label and label.Name == "PlayerLabel" then
				blackballs(label)
			end
		end
	end)
end)

-- health display
local function enableHealthDisplay(character)
	task.wait(1)
	local hum = character:FindFirstChildOfClass("Humanoid")
	if hum then
		hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Viewer
		hum.HealthDisplayType = Enum.HumanoidHealthDisplayType.AlwaysOn
		hum.HealthDisplayDistance = 60
	end
end

local function onCharacterAdded(character)
	enableHealthDisplay(character)
end

local function onPlayerAdded(player)
	if player.Character then onCharacterAdded(player.Character) end
	player.CharacterAdded:Connect(onCharacterAdded)
end

for _, v in ipairs(players:GetPlayers()) do
	onPlayerAdded(v)
end
players.PlayerAdded:Connect(onPlayerAdded)

-- chat visibility
local textChatService = game:GetService("TextChatService")

local function enableChat()
	local config = textChatService:FindFirstChild("ChatWindowConfiguration")
	if config then
		config.Enabled = true
	end
end

enableChat()

plr.CharacterAdded:Connect(function()
	task.wait(1)
	enableChat()
end)

uis.InputBegan:Connect(function(input, gpe)
	if gpe then return end

	--superman
	if input.KeyCode == Enum.KeyCode.Z then
		toggleFly(input)
		return
	end

	-- flight speed
	handleKeyPress(input)

	-- no fall
	if input.KeyCode == Enum.KeyCode.N and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		toggleFallDamage(input)
		return
	end
end)

-- trinket pickup
local trinketPickupEnabled = false
local scanInterval = 1
local nextScan = 0

local function TrinketPickup()
	local character = plr.Character or plr.CharacterAdded:Wait()
	local root = character:WaitForChild("HumanoidRootPart")

	local trinketsPicked = 0

	for _, trinket in ipairs(workspace.Trinkets:GetChildren()) do
		if trinketsPicked >= 2 then break end

		local click = trinket:FindFirstChildOfClass("ClickDetector")
		if not click then
			local part = trinket:FindFirstChild("ClickPart")
			if part then
				click = part:FindFirstChildOfClass("ClickDetector")
			end
		end

		if click and trinket.Position then
			if (root.Position - trinket.Position).Magnitude <= 16 then
				fireclickdetector(click)
				trinketsPicked += 1
			end
		end
	end

	if trinketsPicked >= 2 then
		scanInterval = 0.5
	else
		scanInterval = 1
	end
end


uis.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.B and uis:IsKeyDown(Enum.KeyCode.RightControl) then
		trinketPickupEnabled = not trinketPickupEnabled
		local status = trinketPickupEnabled and "enabled" or "disabled"
		notify("trinket pickup", "trinket pickup " .. status .. ".", 3)
	end
end)


runService.Heartbeat:Connect(function(dt)
	if not trinketPickupEnabled then return end
	if tick() >= nextScan then
		TrinketPickup()
		nextScan = tick() + scanInterval
	end
end)

